<script>
    // Supabase Configuration - USE YOUR ACTUAL CREDENTIALS!
    const SUPABASE_CONFIG = {
        url: 'https://XYZ.supabase.co',
        anonKey: 'ABC'
    };

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - starting form app');
        initializeFormApp();
    });

    function createSupabaseClient() {
        return {
            from: (table) => ({
                select: () => ({
                    eq: (column, value) => ({
                        async single() {
                            console.log('Checking if item exists:', column, value);
                            const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${table}?${column}=eq.${encodeURIComponent(value)}`, {
                                headers: {
                                    'apikey': SUPABASE_CONFIG.anonKey,
                                    'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            if (!response.ok) throw new Error(await response.text());
                            const data = await response.json();
                            return { data: data[0], error: data.length === 0 ? { code: 'PGRST116' } : null };
                        }
                    })
                }),
                insert: (items) => ({
                    async single() {
                        console.log('Inserting item:', items[0]);
                        const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${table}`, {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_CONFIG.anonKey,
                                'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(items[0])
                        });
                        if (!response.ok) throw new Error(await response.text());
                        const data = await response.json();
                        return { data: data[0], error: null };
                    }
                }),
                update: (updates) => ({
                    eq: (column, value) => ({
                        async single() {
                            console.log('Updating item:', column, value, updates);
                            const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${table}?${column}=eq.${encodeURIComponent(value)}`, {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_CONFIG.anonKey,
                                    'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify(updates)
                            });
                            if (!response.ok) throw new Error(await response.text());
                            const data = await response.json();
                            return { data: data[0], error: null };
                        }
                    })
                })
            })
        };
    }

    function initializeFormApp() {
        console.log('Initializing form app...');
        
        // Check credentials
        if (!SUPABASE_CONFIG.url || SUPABASE_CONFIG.url.includes('XYZ')) {
            const errorDiv = document.getElementById('supabaseError');
            if (errorDiv) {
                errorDiv.innerHTML = `
                    <div class="error-state">
                        <h2>⚠️ Configuration Error</h2>
                        <p>Please configure Supabase credentials with your actual values</p>
                    </div>
                `;
            }
            console.error('Supabase credentials not configured');
            return;
        }

        window.supabase = createSupabaseClient();
        console.log('Supabase client created');
        setupForm();
    }

    function setupForm() {
        console.log('Setting up form...');
        
        // Set today's date
        document.getElementById('dateUpdated').valueAsDate = new Date());
        
        // Get form element
        const form = document.getElementById('inventoryForm');
        if (!form) {
            console.error('Form element not found!');
            return;
        }
        
        console.log('Form found, adding event listener');
        
        // Add single event listener
        form.addEventListener('submit', async function(e) {
            console.log('Form submitted - preventing default');
            e.preventDefault();
            await handleFormSubmit();
        });
        
        console.log('Form setup complete');
    }
    
    async function handleFormSubmit() {
        console.log('handleFormSubmit called');
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';
        
        // Get form values
        const items = document.getElementById('itemCategory').value;
        const last_updated = document.getElementById('dateUpdated').value;
        const ending_stock = parseInt(document.getElementById('endingStock').value);
        const beginning_stock = parseInt(document.getElementById('beginningStock').value) || 0;
        
        console.log('Form values:', { items, last_updated, ending_stock, beginning_stock });
        
        try {
            console.log('Checking if item exists...');
            const { data: existingItem, error: checkError } = await window.supabase
                .from('inventory')
                .select()
                .eq('Items', items)
                .single();
            
            if (checkError && checkError.code !== 'PGRST116') {
                throw checkError;
            }
            
            console.log('Existing item check result:', existingItem);
            
            if (existingItem) {
                console.log('Updating existing item');
                const { error } = await window.supabase
                    .from('inventory')
                    .update({
                        "Last Updated": last_updated,
                        "Ending Stock": ending_stock
                    })
                    .eq('Items', items);
                
                if (error) throw error;
                console.log('Update successful');
                alert(`✅ "${items}" updated!`);
            } else {
                console.log('Inserting new item');
                if (!beginning_stock) {
                    alert('⚠️ Please enter Beginning Stock for new items');
                    return;
                }
                
                const reorder_point = Math.max(1, Math.floor(beginning_stock * 0.5));
                console.log('Reorder point calculated:', reorder_point);
                
                const { error } = await window.supabase
                    .from('inventory')
                    .insert([{
                        "Items": items,
                        "Last Updated": last_updated,
                        "Beginning Stock": beginning_stock,
                        "Ending Stock": ending_stock,
                        "Reorder Point": reorder_point,
                        "Status": ending_stock <= reorder_point ? "Low Stock" : "In Stock"
                    }]);
                
                if (error) throw error;
                console.log('Insert successful');
                alert(`✅ "${items}" added to inventory!`);
            }
            
            // Reset form
            document.getElementById('inventoryForm').reset();
            document.getElementById('dateUpdated').valueAsDate = new Date());
            console.log('Form reset');
            
        } catch (error) {
            console.error('Error in handleFormSubmit:', error);
            alert('❌ Error: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save to Inventory';
            console.log('Form submit process completed');
        }
    }
    
    async function clearAllData() {
        if (confirm('Clear ALL inventory data? This cannot be undone!')) {
            try {
                await window.supabase
                    .from('inventory')
                    .delete()
                    .neq('Items', 'dummy');
                
                alert('All data cleared!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    }

    window.clearAllData = clearAllData;
</script>
